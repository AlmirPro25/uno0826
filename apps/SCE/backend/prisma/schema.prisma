datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  role         String   @default("ADMIN")
  
  // UNO.KERNEL Integration - Multi-tenant isolation
  kernelUserId    String?  @unique  // ID da identidade no Kernel
  kernelAppId     String?  @unique  // ID do App no Kernel (1 user = 1 app)
  kernelAppKey    String?           // API Key do App (pq_pk_xxx)
  kernelAppSecret String?           // API Secret do App (pq_sk_xxx)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Project {
  id          String       @id @default(uuid())
  name        String       @unique
  type        String       @default("BACKEND") // FRONTEND | BACKEND
  repoUrl     String
  branch      String       @default("main")
  buildCmd    String?
  startCmd    String?
  port        Int          @default(3000)
  subdomain   String       @unique
  ownerId     String       // ID do usu√°rio dono (vem do PROST-QS)
  envVars     EnvVar[]
  deployments Deployment[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([ownerId])
}

model Deployment {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  status    String   @default("QUEUED") // QUEUED | BUILDING | DEPLOYING | HEALTHY | FAILED | STOPPED
  imageTag  String
  logs      String?
  cpuUsage  Float    @default(0)
  memUsage  Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
}

model EnvVar {
  id        String  @id @default(uuid())
  key       String
  value     String  // Criptografado em AES-256
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([key, projectId])
  @@index([projectId])
}
